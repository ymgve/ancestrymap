<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ancestor Timeline Map (Leaflet)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 80vh; width: 100%; }
    #controls {
      padding: 10px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #yearLabel { font-weight: bold; }
    .popup-form {
      font-size: 14px;
    }
    .popup-form input, .popup-form select {
      width: 100%;
      margin: 3px 0;
      box-sizing: border-box;
    }
    .popup-form button {
      margin-top: 5px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div>
      <label>Year: <span id="yearLabel">1900</span></label>
      <input type="range" id="yearSlider" min="1500" max="2025" value="1900" />
    </div>
    <div>
      <button id="exportBtn">Export</button>
      <button id="importBtn">Import</button>
      <input type="file" id="importFile" style="display:none" />
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];
    let ancestors = JSON.parse(localStorage.getItem("ancestors") || "[]");

    function getUniqueNames() {
      let names = ancestors.map(a => a.name);
      return [...new Set(names)].sort();
    }

    function renderMarkers() {
      // clear old markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      let year = parseInt(document.getElementById("yearSlider").value);
      document.getElementById("yearLabel").textContent = year;

      ancestors.forEach(a => {
        if (a.startYear <= year && year <= a.endYear) {
          let marker = L.marker([a.lat, a.lng])
            .addTo(map)
            .bindPopup(`<b>${a.name}</b><br>${a.startYear}â€“${a.endYear}`);
          markers.push(marker);
        }
      });
    }

    // Add ancestor by clicking the map
    map.on("click", (e) => {
      let uniqueNames = getUniqueNames();
      let options = uniqueNames.map(n => `<option value="${n}">${n}</option>`).join("");

      let formHtml = `
        <form class="popup-form">
          <label>Choose or enter ancestor:</label>
          <select id="ancestorSelect">
            <option value="">-- New Ancestor --</option>
            ${options}
          </select>
          <input type="text" id="ancestorName" placeholder="New ancestor name" />

          <label>Start Year:</label>
          <input type="number" id="startYear" required />

          <label>End Year:</label>
          <input type="number" id="endYear" required />

          <button type="button" id="saveAncestor">Save</button>
        </form>
      `;

      let popup = L.popup()
        .setLatLng(e.latlng)
        .setContent(formHtml)
        .openOn(map);

      setTimeout(() => {
        let select = document.getElementById("ancestorSelect");
        let nameInput = document.getElementById("ancestorName");

        // Auto-fill name input if selecting existing ancestor
        select.addEventListener("change", () => {
          if (select.value) {
            nameInput.value = select.value;
          } else {
            nameInput.value = "";
          }
        });

        document.getElementById("saveAncestor").addEventListener("click", () => {
          let name = nameInput.value.trim();
          if (!name) { alert("Please enter a name."); return; }

          let start = parseInt(document.getElementById("startYear").value);
          let end = parseInt(document.getElementById("endYear").value);
          if (isNaN(start) || isNaN(end)) { alert("Enter valid years."); return; }

          ancestors.push({ name, lat: e.latlng.lat, lng: e.latlng.lng, startYear: start, endYear: end });
          localStorage.setItem("ancestors", JSON.stringify(ancestors));
          renderMarkers();
          map.closePopup();
        });
      }, 100); // delay so popup DOM exists
    });

    document.getElementById("yearSlider").addEventListener("input", renderMarkers);

    document.getElementById("exportBtn").addEventListener("click", () => {
      let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ancestors));
      let a = document.createElement("a");
      a.setAttribute("href", dataStr);
      a.setAttribute("download", "ancestors.json");
      a.click();
    });

    document.getElementById("importBtn").addEventListener("click", () => {
      document.getElementById("importFile").click();
    });

    document.getElementById("importFile").addEventListener("change", e => {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = event => {
        ancestors = JSON.parse(event.target.result);
        localStorage.setItem("ancestors", JSON.stringify(ancestors));
        renderMarkers();
      };
      reader.readAsText(file);
    });

    renderMarkers();
  </script>
</body>
</html>
