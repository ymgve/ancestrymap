<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ancestor Timeline Map (Leaflet)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root {
      --bg: #f7f7f8;
      --panel: #ffffff;
      --text: #222;
      --muted: #666;
      --accent: #2f7dd1;
    }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: var(--text); background: var(--bg); }
    #map { height: 78vh; width: 100%; }
    #controls {
      padding: 10px 12px; background: var(--panel); display: flex; align-items: center; justify-content: space-between; gap: 12px; box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    #leftControls { display: flex; align-items: center; gap: 10px; flex: 1; max-width: 60%; }
    #yearLabel { font-weight: 700; min-width: 80px; }
    #yearSlider { flex: 1; min-width: 200px; }
    .year-controls { display: flex; align-items: center; gap: 8px; }
    .btn { border: 1px solid #ddd; background: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn:hover { background: #f0f3f8; }
    .btn-small-year { border: 1px solid #ddd; background: #fff; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; min-width: 30px; }
    .btn-small-year:hover { background: #f0f3f8; }

    /* Popup UI */
    .popup-form, .popup-group { font-size: 14px; min-width: 240px; }
    .popup-form label { font-size: 12px; color: var(--muted); }
    .popup-form input, .popup-form select { width: 100%; margin: 4px 0 8px; box-sizing: border-box; padding: 6px 8px; }
    .popup-form .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .popup-form .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px; }
    .popup-form button { padding: 6px 8px; border-radius: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .popup-form button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

    .res-list { list-style: none; padding: 0; margin: 6px 0; }
    .res-list li { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #eee; }
    .res-list li:last-child { border-bottom: none; }
    .res-title { font-weight: 600; }
    .res-years { color: var(--muted); font-size: 12px; }
    .btn-row { display: flex; gap: 6px; }
    .btn-small { padding: 4px 6px; border-radius: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 12px; }
    .btn-small.danger { border-color: #e06464; color: #b00020; }
    .add-here { margin-top: 8px; width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .arrow-icon { background: transparent !important; border: none !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div id="leftControls">
      <div class="year-controls">
        <button id="yearMinus10" class="btn-small-year" title="Go back 10 years">-10</button>
        <button id="yearMinus1" class="btn-small-year" title="Go back 1 year">-1</button>
      </div>
      <label>Year: <span id="yearLabel">1900</span></label>
      <input type="range" id="yearSlider" min="1500" max="2025" value="1900" />
      <div class="year-controls">
        <button id="yearPlus1" class="btn-small-year" title="Go forward 1 year">+1</button>
        <button id="yearPlus10" class="btn-small-year" title="Go forward 10 years">+10</button>
      </div>
    </div>
    <div>
      <button id="exportBtn" class="btn">Export</button>
      <button id="importBtn" class="btn">Import</button>
      <input type="file" id="importFile" style="display:none" />
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Utilities ---
    const $ = (sel, root = document) => root.querySelector(sel);
    function uid() { return 'id-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }
    function escapeHtml(s="") { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    const keyFrom = (lat, lng) => `${(+lat).toFixed(5)},${(+lng).toFixed(5)}`; // ~1m precision

    // --- Map ---
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    let markers = [];
    let arrows = [];
    let ancestors = JSON.parse(localStorage.getItem('ancestors') || '[]');

    // Migrate records to include stable IDs (for per-record edit/delete)
    let migrated = false;
    ancestors.forEach(a => { if (!a.id) { a.id = uid(); migrated = true; } });
    if (migrated) saveData();

    function saveData() { localStorage.setItem('ancestors', JSON.stringify(ancestors)); }
    function currentYear() { return parseInt($('#yearSlider').value, 10); }

    function getUniqueNames() {
      return [...new Set(ancestors.map(a => a.name))].filter(Boolean).sort((a,b)=>a.localeCompare(b));
    }

    function groupVisibleByLocation(year) {
      const groups = new Map();
      ancestors.forEach((a, index) => {
        if (Number(a.startYear) <= year && year <= Number(a.endYear)) {
          const key = keyFrom(a.lat, a.lng);
          if (!groups.has(key)) groups.set(key, { lat: a.lat, lng: a.lng, items: [] });
          groups.get(key).items.push({ ...a, index });
        }
      });
      return groups;
    }

    function clearMarkers() { 
      markers.forEach(m => map.removeLayer(m)); 
      markers = []; 
      arrows.forEach(a => map.removeLayer(a)); 
      arrows = [];
    }

    function findMigrations(year) {
      const migrations = [];
      
      // Group ancestors by person name to track their movements
      const peopleByName = new Map();
      ancestors.forEach(record => {
        if (!peopleByName.has(record.name)) {
          peopleByName.set(record.name, []);
        }
        peopleByName.get(record.name).push(record);
      });
      
      // For each person, find migrations that happen in the current year
      peopleByName.forEach((records, name) => {
        // Sort records by start year to get chronological order
        const sortedRecords = records.sort((a, b) => a.startYear - b.startYear);
        
        for (let i = 0; i < sortedRecords.length - 1; i++) {
          const current = sortedRecords[i];
          const next = sortedRecords[i + 1];
          
          // Check if migration happens in the selected year
          // Migration occurs when current period ends and next period starts in the same year
          if (current.endYear === year && next.startYear === year) {
            migrations.push({
              name: name,
              from: { lat: current.lat, lng: current.lng },
              to: { lat: next.lat, lng: next.lng }
            });
          }
        }
      });
      
      return migrations;
    }

    function renderArrows(year) {
      const migrations = findMigrations(year);
      
      migrations.forEach(migration => {
        // Create arrow line
        const arrow = L.polyline([
          [migration.from.lat, migration.from.lng],
          [migration.to.lat, migration.to.lng]
        ], {
          color: '#e74c3c',
          weight: 3,
          opacity: 0.8,
          dashArray: '10, 5'
        }).addTo(map);
        
        // Add arrow head using a marker
        const midLat = (migration.from.lat + migration.to.lat) / 2;
        const midLng = (migration.from.lng + migration.to.lng) / 2;
        
        // Calculate angle for arrow direction
        const angle = Math.atan2(
          migration.to.lat - migration.from.lat,
          migration.to.lng - migration.from.lng
        ) * 180 / Math.PI;
        
        // Create custom arrow icon
        const arrowIcon = L.divIcon({
          html: `<div style="transform: rotate(${angle + 90}deg); color: #e74c3c; font-size: 16px;">▲</div>`,
          className: 'arrow-icon',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });
        
        const arrowMarker = L.marker([midLat, midLng], { 
          icon: arrowIcon,
          title: `${migration.name} migrated in ${year}`
        }).addTo(map);
        
        arrows.push(arrow);
        arrows.push(arrowMarker);
      });
    }

    function renderMarkers() {
      clearMarkers();
      const year = currentYear();
      $('#yearLabel').textContent = year;

      const groups = groupVisibleByLocation(year);
      groups.forEach(group => {
        const marker = L.marker([group.lat, group.lng]).addTo(map);
        marker.on('click', () => openGroupPopup({lat: group.lat, lng: group.lng}, year));
        markers.push(marker);
      });
      
      // Render migration arrows for the current year
      renderArrows(year);
    }

    function getGroupAt(latlng, year) {
      const key = keyFrom(latlng.lat, latlng.lng);
      const items = ancestors.filter(a => keyFrom(a.lat, a.lng) === key && Number(a.startYear) <= year && year <= Number(a.endYear));
      return { lat: latlng.lat, lng: latlng.lng, items };
    }

    function openGroupPopup(latlng, year) {
      const group = getGroupAt(latlng, year);
      if (!group.items.length) { map.closePopup(); return; }

      const list = group.items.map(item => `
        <li>
          <div>
            <div class="res-title">${escapeHtml(item.name)}</div>
            <div class="res-years">${item.startYear} — ${item.endYear}</div>
          </div>
          <div class="btn-row">
            <button class="btn-small" onclick="editAncestor('${item.id}')">Edit</button>
            <button class="btn-small danger" onclick="deleteAncestor('${item.id}', ${latlng.lat}, ${latlng.lng})">Delete</button>
          </div>
        </li>`).join('');

      const html = `
        <div class="popup-group">
          <div><strong>${group.items.length}</strong> record${group.items.length>1?'s':''} here in <strong>${year}</strong></div>
          <ul class="res-list">${list}</ul>
          <button class="add-here" onclick="openFormPopup({lat: ${latlng.lat}, lng: ${latlng.lng}})">Add Another Person Here</button>
        </div>`;

      L.popup().setLatLng(latlng).setContent(html).openOn(map);
    }

    // Global functions for button clicks
    window.editAncestor = function(id) {
      const rec = ancestors.find(x => x.id === id);
      if (rec) {
        openFormPopup({lat: rec.lat, lng: rec.lng}, rec);
      }
    };

    window.deleteAncestor = function(id, lat, lng) {
      if (confirm('Delete this record?')) {
        const recIndex = ancestors.findIndex(x => x.id === id);
        if (recIndex !== -1) {
          ancestors.splice(recIndex, 1);
          saveData();
          renderMarkers();
          // Re-open group popup at same location for current year (if any remain)
          openGroupPopup({lat, lng}, currentYear());
        }
      }
    };

    function openFormPopup(latlng, existing=null) {
      const names = getUniqueNames();
      const options = names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');

      const html = `
        <form class="popup-form" onsubmit="return false;">
          <label>Choose or enter ancestor</label>
          <select id="ancestorSelect" onchange="document.getElementById('ancestorName').value = this.value">
            <option value="">— New Ancestor —</option>
            ${options}
          </select>
          <input type="text" id="ancestorName" placeholder="Name" value="${existing ? escapeHtml(existing.name) : ''}" />
          <div class="row">
            <div>
              <label>Start Year</label>
              <input type="number" id="startYear" value="${existing ? existing.startYear : ''}" />
            </div>
            <div>
              <label>End Year</label>
              <input type="number" id="endYear" value="${existing ? existing.endYear : ''}" />
            </div>
          </div>
          <div class="actions">
            <button type="button" class="primary" onclick="saveAncestor(${latlng.lat}, ${latlng.lng}, ${existing ? `'${existing.id}'` : 'null'})">${existing ? 'Update' : 'Save'}</button>
            <button type="button" onclick="map.closePopup()">Cancel</button>
          </div>
        </form>`;

      L.popup().setLatLng(latlng).setContent(html).openOn(map);
    }

    // Global function for saving
    window.saveAncestor = function(lat, lng, existingId) {
      const nameInput = document.getElementById('ancestorName');
      const startInput = document.getElementById('startYear');
      const endInput = document.getElementById('endYear');
      
      const name = (nameInput.value || '').trim();
      const start = parseInt(startInput.value, 10);
      const end = parseInt(endInput.value, 10);
      
      if (!name) { alert('Please enter a name.'); return; }
      if (isNaN(start) || isNaN(end)) { alert('Please enter valid years.'); return; }

      if (existingId) {
        // Update existing record
        const idx = ancestors.findIndex(x => x.id === existingId);
        if (idx !== -1) {
          ancestors[idx] = { ...ancestors[idx], name, startYear: start, endYear: end, lat, lng };
        }
      } else {
        // Add new record
        ancestors.push({ id: uid(), name, lat, lng, startYear: start, endYear: end });
      }

      saveData();
      renderMarkers();
      // After saving, show the group popup at this location for the current year
      openGroupPopup({lat, lng}, currentYear());
    };

    // Click on empty map to add new entry at that spot
    map.on('click', (e) => { openFormPopup(e.latlng); });

    // Slider re-renders markers; also close any open popup to avoid stale content
    $('#yearSlider').addEventListener('input', () => { map.closePopup(); renderMarkers(); });

    // Year navigation buttons
    function changeYear(delta) {
      const slider = $('#yearSlider');
      const currentYear = parseInt(slider.value, 10);
      const newYear = Math.max(1500, Math.min(2025, currentYear + delta));
      slider.value = newYear;
      map.closePopup();
      renderMarkers();
    }

    $('#yearMinus10').addEventListener('click', () => changeYear(-10));
    $('#yearMinus1').addEventListener('click', () => changeYear(-1));
    $('#yearPlus1').addEventListener('click', () => changeYear(1));
    $('#yearPlus10').addEventListener('click', () => changeYear(10));

    // Export / Import
    $('#exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(ancestors, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ancestors.json'; a.click();
      URL.revokeObjectURL(url);
    });

    $('#importBtn').addEventListener('click', () => { $('#importFile').click(); });
    $('#importFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!Array.isArray(data)) throw new Error('Invalid file format.');
          // Ensure IDs exist
          data.forEach(d => { if (!d.id) d.id = uid(); });
          ancestors = data;
          saveData();
          map.closePopup();
          renderMarkers();
        } catch (err) {
          alert('Failed to import: ' + err.message);
        }
      };
      reader.readAsText(file);
    });

    renderMarkers();
  </script>
</body>
</html>